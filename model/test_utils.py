# -*- coding: utf-8 -*-
from unittest import TestCase
from numpy import ndarray
from numpy import array
from model.utils import expand_matrix
from model.beams import BeamB_3DOF
from model.elements import by_axial_length


class TestBaseCase(TestCase):
    def assertAlmostEqualMatrix(
        self, e: ndarray, a: ndarray, tol: float, msg: str = ""
    ) -> None:
        self.assertTrue(
            len(e.shape) == len(a.shape) == 2, msg=msg + " -- required dimension 2"
        )
        self.assertEqual(e.shape, a.shape, msg=msg + " -- shape")
        for row in range(0, e.shape[0]):
            for col in range(0, e.shape[1]):
                self.assertAlmostEqual(
                    a[row, col],
                    e[row, col],
                    delta=tol,
                    msg=(
                        f'{msg} -- matrix ({"x".join(map(str, e.shape))}) -- row={row},'
                        f" col={col}"
                    ),
                )


class TestBeamB(TestBaseCase):
    def test_system_K(self):
        print("< test system [K] matrix")

        expected: ndarray = array(
            [
                [
                    19473541221.0104,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    63624991231.2051,
                    92256237285.2474,
                    0.0000,
                    -63624991231.2051,
                    92256237285.2474,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    92256237285.2474,
                    178362058751.4780,
                    0.0000,
                    -92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    38947082442.0208,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    -63624991231.2051,
                    -92256237285.2474,
                    0.0000,
                    127249982462.4100,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    92256237285.2474,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    356724117502.9570,
                    0.0000,
                    -92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    38947082442.0208,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    -92256237285.2474,
                    0.0000,
                    127249982462.4100,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    92256237285.2474,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    356724117502.9570,
                    0.0000,
                    -92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    38947082442.0208,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    -92256237285.2474,
                    0.0000,
                    127249982462.4100,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    92256237285.2474,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    356724117502.9570,
                    0.0000,
                    -92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    38947082442.0208,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    -92256237285.2474,
                    0.0000,
                    127249982462.4100,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    92256237285.2474,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    0.0000,
                    356724117502.9570,
                    0.0000,
                    -92256237285.2474,
                    89181029375.7392,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -19473541221.0104,
                    0.0000,
                    0.0000,
                    19473541221.0104,
                    0.0000,
                    0.000,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    -63624991231.2051,
                    -92256237285.2474,
                    0.0000,
                    63624991231.2051,
                    -92256237285.2474,
                ],
                [
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    0.0000,
                    92256237285.2474,
                    89181029375.7392,
                    0.0000,
                    -92256237285.2474,
                    178362058751.478,
                ],
            ]
        )
        print(f'    expected [K] size: {"x".join(map(str, expected.shape))}')

        beam_3dof: BeamB_3DOF = BeamB_3DOF(
            *by_axial_length(BeamB_3DOF.get_dofs(), 2.9),
            e_modul=2.1e11,
            area_moi=0.615773774261056,
            area=0.268920331147286,
            mass=6121.97133856797,
        )

        actual: ndarray = beam_3dof.get_K()
        # repeats stiffness matrix to simulate matrix expansion from element to system
        for _ in range(1, 5):
            actual = expand_matrix(actual, beam_3dof.get_K())
        self.assertAlmostEqualMatrix(expected, actual, tol=1.0e-3, msg="[K]")
        print("> OK")

    def test_system_M(self):
        print("< test system [M] matrix")

        expected: ndarray = array(
            [
                [
                    2040.657113,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    2273.875069,
                    929.9565986,
                    0,
                    787.1106007,
                    -549.5198082,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    929.9565986,
                    490.340752,
                    0,
                    549.5198082,
                    -367.755564,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    1020.328556,
                    0,
                    0,
                    4081.314226,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    787.1106007,
                    549.5198082,
                    0,
                    4547.750137,
                    0,
                    0,
                    787.1106007,
                    -549.5198082,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    -549.5198082,
                    -367.755564,
                    0,
                    0,
                    980.6815039,
                    0,
                    549.5198082,
                    -367.755564,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    4081.314226,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    787.1106007,
                    549.5198082,
                    0,
                    4547.750137,
                    0,
                    0,
                    787.1106007,
                    -549.5198082,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    -549.5198082,
                    -367.755564,
                    0,
                    0,
                    980.6815039,
                    0,
                    549.5198082,
                    -367.755564,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    4081.314226,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    787.1106007,
                    549.5198082,
                    0,
                    4547.750137,
                    0,
                    0,
                    787.1106007,
                    -549.5198082,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    -549.5198082,
                    -367.755564,
                    0,
                    0,
                    980.6815039,
                    0,
                    549.5198082,
                    -367.755564,
                    0,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    4081.314226,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    787.1106007,
                    549.5198082,
                    0,
                    4547.750137,
                    0,
                    0,
                    787.1106007,
                    -549.5198082,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    -549.5198082,
                    -367.755564,
                    0,
                    0,
                    980.6815039,
                    0,
                    549.5198082,
                    -367.755564,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    1020.328556,
                    0,
                    0,
                    2040.657113,
                    0,
                    0,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    787.1106007,
                    549.5198082,
                    0,
                    2273.875069,
                    -929.9565986,
                ],
                [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    -549.5198082,
                    -367.755564,
                    0,
                    -929.9565986,
                    490.340752,
                ],
            ]
        )

        print(f'    expected [M] size: {"x".join(map(str, expected.shape))}')

        beam_3dof: BeamB_3DOF = BeamB_3DOF(
            *by_axial_length(BeamB_3DOF.get_dofs(), 2.9),
            e_modul=2.1e11,
            area_moi=0.615773774261056,
            area=0.268920331147286,
            mass=6121.97133856797,
        )

        actual: ndarray = beam_3dof.get_M()
        # repeats mass matrix to simulate matrix expansion from element to system
        for _ in range(1, 5):
            actual = expand_matrix(actual, beam_3dof.get_M())
        self.assertAlmostEqualMatrix(expected, actual, tol=1.0e-6, msg="[M]")
        print("> OK")
